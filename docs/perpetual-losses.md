# Implementation of Losses

In this document, we explain the losses in the PNL formula in the [margin account](margin-account-model.md) where

```
PNL2 = PNL1 - SocialLoss - FundingLoss
              ^^^^^^^^^^   ^^^^^^^^^^^
```

The principles of `SocialLoss` and `FundingLoss` are very different, we explain separately.

## SocialLoss

A SocialLoss is generated by [liquidate](perpetual.md#liquidateaccount-maxamount). If there is a bankrupt account, the difference between Mark Price and Bankrupt Price is the loss of the liquidation. The loss is first made up by the insurance fund. If the fund is insufficient to cover the loss, the smart contract will socialize the loss. In this case, all the opponent position holders share the loss according to their position size.

### A Basic Example

Alice and Bob both have 1 long position and their `EntryPrice = IndexPrice = 7000`. Alice is going bankrupt because IndexPrice decreases.

| IndexPrice  | A Position | A MarginBalance | B position | B MarginBalance |
|:-----------:|:----------:|:---------------:|:----------:|:---------------:|
| 7000        | 1          | 1000            | 1          | 7000            |
| 5000        | 1          | -1000           | 1          | 5000            |
| Liquidate A | 0          | 0               | 1          | 4998.95 (explained below) |

We assume `MarkPrice = IndexPrice = 5000`. `PenaltyRate = 1%`. Balance of insurance fund = 0. All long positions in this Perpetual = 1000. 

```
PNL1 = (MarkPrice - EntryPrice) * PositionSize = -2000
PNL2 = PNL1  // For the convenience of explanation, losses are temporarily ignored here
Penalty = PenaltyRate * MarkPrice * PositionSize = 50
LiquidationLoss = -(CashBalance + PNL2 - Penalty) = 1050
```

The `liquidate` process will generates 1050 collateral losses, and all long positions will share these losses equally.

```
New LongSocialLossPerContract = LiquidationLoss / Total Position Size = 1.05
```

After this process, Bob's PNL is changed to:

```
PNL1 = (MarkPrice - EntryPrice) * PositionSize = -2000
SocialLoss = LongSocialLossPerContract * PositionSize = 1.05
PNL2 = PNL1 - SocialLoss = -2001.05   // For the convenience of explanation, other losses are temporarily ignored here
```

### Algorithm

An obvious design requirement is that traders can bear SocialLoss only if they have a position. If a trader have 10 long positions (A) before the time when the SocialLoss will occur (B), and he add 10 more long positions after liquidation (C), only the first 10 long positions can participate in calculating SocialLoss. Aka: his SocialLoss = LongSocialLossPerContract * 10 = 10.

```
      PositionSize                        PositionSize
      = 10 long                           = 20 long
 ----------A------------------B----------------C---------> time
           |                  |
           |              liquidate
    LongSocialLoss     LongSocialLoss
    PerContract = 0    PerContract = 1
```

In the Perpetual contract, we achieve this requirement by introducing EntrySocialLoss:

```
SocialLoss (when calculating PNL2):= (Long/ShortSocialLossPerContract - EntrySocialLoss / PositionSize) * Amount
If opening positions, EntrySocialLoss:= EntrySocialLoss + Long/ShortSocialLossPerContract * Trading Amount
If closing positions, EntrySocialLoss:= EntrySocialLoss / PositionSize * (PositionSize - Trading Amount)
```

This algorithm only works if Long/ShortSocialLossPerContract are both monotonically increasing.

## FundingLoss

The `FundingLoss` is related to the [funding payment](funding-rate.md#funding-payment). If Alice holds long positions, while the `FundingRate` is positive, she has to pay to shorts. At this time, Alice's `FundingLoss` is a positive number, which reduces her `PNL2`.

Unlike the `Long/ShortSocialLossPerContract`, the sign direction of `FundingRate` can be changed. After Alice enters 10 long positions, suppose that `FundingRate` remains negative in A part for a period of time, and then turn around to positive in B part, in principle Alice should obtain FundingPayment and then losing FundingPayment.

```
^ FundingRate                               ^ AccumulatedFunding
|                   **********              | PerContract
|                  *  B part                |***                     **
|                 *                         |   **                 **
+----x-----------*-----------x-> time       +----x**-------------**-x-> time
|    |          *            |              |    |  **         **   |
|    | A part  *             |              |    |    **     **     |
|    |*********              |              |    |      ** **       |
|    |                       |              |    |        *         |
|  Enter                    Now             |  Enter               Now
```

We implemented an `AccumulatedFundingPerContract` which sums `FundingPayment` from -âˆž to now. So that `FundingLoss` can be calculated by comparing the current `AccumulatedFundingPerContract` to the historical value.

```
FundingLoss (when calculating PNL2):= AccumulatedFundingPerContract * PositionSize - EntryFundingLoss for long positions. Opposite it for short positions
If opening positions, EntryFundingLoss:= EntryFundingLoss + AccumulatedFundingPerContract * Trading Amount
If closing positions, EntryFundingLoss:= EntryFundingLoss / PositionSize * (PositionSize - Trading Amount)
```
